name: Build Multi-Architecture APKs
on:
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.abi }} APK
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # abi: [arm64-v8a, armeabi-v7a, x86_64, x86]
        abi: [arm64-v8a]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: Patch Dependencies & Paths
        run: |
          sed -i 's/"@mastra\/core": ".*"/"@mastra\/core": "0.23.1"/g' package.json
          sed -i 's/"@mastra\/libsql": ".*"/"@mastra\/libsql": "0.15.1"/g' package.json
          mkdir -p src/renderer/src/renderer
          ln -s ../routes src/renderer/src/renderer/routes

      - name: Create Capacitor Config
        run: |
          cat <<EOF > capacitor.config.json
          {
            "appId": "com.custom.chatbox.build",
            "appName": "Chatbox Source",
            "webDir": "release/app/dist/renderer",
            "server": {
              "cleartext": true,
              "androidScheme": "http"
            },
            "android": {
              "allowMixedContent": true
            }
          }
          EOF
      
      - name: View Capacitor Config
        run: |
          echo "--- START capacitor.config.json ---"
          cat capacitor.config.json
          echo "--- END capacitor.config.json ---"

      - name: Install Dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build Web Assets (Mobile Target)
        run: CHATBOX_BUILD_TARGET=mobile_app pnpm run build

      - name: Generate Android Platform
        run: |
          pnpm install -w @capacitor/android @capacitor/core @capacitor/cli
          npx cap add android

      - name: Decode Keystore
        run: echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 -d > release.jks
      
      - name: Generate App Icons
        run: |
          pnpm install @capacitor/assets -g
          npx capacitor-assets generate --android
      
      - name: Find Export Path Logic
        run: |
          echo "--- Searching for folder name ---"
          grep -r "chatbox_ai_exports" . || echo "Folder string not found"
          echo "--- Searching for Filesystem calls ---"
          grep -r "Filesystem" src | head -n 20 || echo "No Filesystem calls found"
          grep -r "Directory.Documents" src || echo "No Documents ref found"
          grep -r "chatbox_ai_exports" src || echo "No folder name found"
      
      - name: UI & Plugin Search
        run: |
          echo "--- Searching for the 'Export' UI Label ---"
          # This looks for the word 'Export' in the UI components
          grep -rE "Export|Backup|Share" src | head -n 30
          
          echo "--- Checking Installed Plugins ---"
          # This tells us if the app even has the Filesystem or Share plugins installed
          cat package.json | grep "@capacitor"
            
      - name: Sync & Build APK
        run: |
          mkdir -p release/app/dist/renderer
          npx cap sync android
          npx cap update android

          # 1. Force Bridge Activity & Plugin Initialization
          ACTIVITY_PATH="android/app/src/main/java/com/custom/chatbox/build/MainActivity.java"
          
          # Overwrite the file with a version that forces the bridge to load
          cat <<EOF > $ACTIVITY_PATH
          package com.custom.chatbox.build;
          import android.os.Bundle;
          import com.getcapacitor.BridgeActivity;

          public class MainActivity extends BridgeActivity {
              @Override
              public void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
              }
          }
          EOF

          # 2. Overwrite Manifest (The Safe Fix)
          # We write the entire file from scratch to ensure perfect XML structure.
          cat <<EOF > android/app/src/main/AndroidManifest.xml
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <uses-permission android:name="android.permission.INTERNET" />
              <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" android:maxSdkVersion="32" />
              <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" android:maxSdkVersion="30" />
              <uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE" />
              <uses-permission android:name="android.permission.QUERY_ALL_PACKAGES" />

              <application
                  android:allowBackup="true"
                  android:icon="@mipmap/ic_launcher"
                  android:label="@string/app_name"
                  android:roundIcon="@mipmap/ic_launcher_round"
                  android:supportsRtl="true"
                  android:theme="@style/AppTheme"
                  android:requestLegacyExternalStorage="true"
                  android:preserveLegacyExternalStorage="true"
                  android:extractNativeLibs="true">

                  <activity
                      android:configChanges="orientation|keyboardHidden|keyboard|screenSize|locale|smallestScreenSize|screenLayout|uiMode"
                      android:name="com.custom.chatbox.build.MainActivity"
                      android:label="@string/title_activity_main"
                      android:theme="@style/AppTheme.NoActionBarLaunch"
                      android:launchMode="singleTask"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>

                  <provider
                      android:name="androidx.core.content.FileProvider"
                      android:authorities="com.custom.chatbox.build.fileprovider"
                      android:exported="false"
                      android:grantUriPermissions="true">
                      <meta-data
                          android:name="android.support.FILE_PROVIDER_PATHS"
                          android:resource="@xml/file_paths" />
                  </provider>
              </application>
          </manifest>
          EOF

          # 3. Create File Paths
          mkdir -p android/app/src/main/res/xml
          echo '<?xml version="1.0" encoding="utf-8"?><paths><external-path name="external_files" path="." /><cache-path name="cache" path="." /><files-path name="files" path="." /><root-path name="root" path="." /></paths>' > android/app/src/main/res/xml/file_paths.xml

          # 4. Final Build Steps
          cd android
          # Check if splits are already there to avoid duplicates
          if ! grep -q "splits" app/build.gradle; then
             sed -i '/android {/a \    splits { abi { enable true; reset(); include "${{ matrix.abi }}"; universalApk false } }' app/build.gradle
          fi
          
          sed -i '/android {/a \    applicationVariants.all { variant -> variant.outputs.all { output -> outputFileName = "app-${{ matrix.abi }}-chatbox.apk" } }' app/build.gradle
          sed -i '/android {/a \    signingConfigs { debug { storeFile file("../../release.jks"); storePassword "${{ secrets.KEY_PASS }}"; keyAlias "chatbox-key"; keyPassword "${{ secrets.KEY_PASS }}" } }' app/build.gradle

          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: chatbox-${{ matrix.abi }}
          path: android/app/build/outputs/apk/debug/app-${{ matrix.abi }}-chatbox.apk

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: apks
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: "Chatbox Source Build #${{ github.run_number }}"
          body: "Automated multi-architecture builds for Chatbox."
          draft: false
          prerelease: false
          files: apks/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}